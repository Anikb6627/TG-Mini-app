<!--
File: ludo_telegram_webapp.html
Purpose: Minimal Ludo Telegram WebApp prototype + Coin Wallet UI + integration notes.
Instructions: Save this file and open in browser for local testing. For real multiplayer use, deploy a server (Node.js + Socket.IO) and change SOCKET_URL below.

This single-file prototype contains:
1) Simple responsive HTML5 Ludo board (2-player local / basic moves) using canvas and JS.
2) Telegram WebApp initialization snippet (uses Telegram.WebApp if opened inside Telegram).
3) Coin wallet UI and sample API calls (placeholders) to integrate with backend endpoints: /api/buy_coins, /api/get_balance, /api/report_result
4) Example Node.js server stub is included at the bottom in a commented code block for copy-paste.

Remember: This is an MVP prototype for testing UX and flows. For production with real money you MUST add server-side authoritative game logic, secure payment integration, KYC flows, encryption, anti-cheat, and legal compliance.
--><!doctype html>

<html lang="bn">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Telegram Ludo WebApp - Prototype</title>
  <style>
    :root{--accent:#2b7cff}
    body{font-family:system-ui,Segoe UI,Roboto,'Noto Sans Bengali',sans-serif;margin:0;padding:0;background:#f4f6fb;color:#0b1230}
    header{background:linear-gradient(90deg,#fff 0%,#eef4ff 100%);padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
    header h1{font-size:18px;margin:0}
    .container{max-width:980px;margin:18px auto;padding:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(12,25,48,0.06);flex:1;min-width:260px}
    canvas{background:#fff;border-radius:8px;display:block;margin:12px auto}
    .controls{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:8px}
    button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .muted{color:#556}
    .wallet{display:flex;gap:8px;align-items:center}
    .balance{font-weight:700}
    .log{height:140px;overflow:auto;background:#0b15301a;border-radius:8px;padding:8px;font-size:13px}
    .small{font-size:13px}
    @media(max-width:700px){.row{flex-direction:column}}
  </style>
</head>
<body>
  <header>
    <h1>Telegram Ludo — Prototype</h1>
    <div class="wallet">
      <div class="small muted">Coins:</div>
      <div id="balance" class="balance">0</div>
      <button id="buyBtn">Buy 100 Coins</button>
    </div>
  </header>  <div class="container">
    <div class="row">
      <div class="card" style="flex:2">
        <h3>Game Board</h3>
        <canvas id="board" width="480" height="480"></canvas>
        <div class="controls">
          <button id="rollBtn">Roll Dice</button>
          <div id="diceDisplay" class="muted">Dice: -</div>
          <button id="endTurnBtn">End Turn</button>
        </div>
        <div class="small muted" style="text-align:center;margin-top:8px">Note: This prototype is <strong>client-side</strong> and meant for UX/demo. For fairness move validation must be server-side.</div>
      </div><div class="card" style="flex:1">
    <h3>Match & Wallet</h3>
    <div style="margin-bottom:8px">Mode: <strong id="mode">Coin Battle</strong></div>
    <div style="margin-bottom:8px"><label>Entry Fee: <strong id="entryFee">50</strong> coins</label></div>
    <div style="display:flex;gap:8px;margin-bottom:8px"><button id="joinBtn">Join Match</button><button id="leaveBtn">Leave</button></div>

    <h4>Actions</h4>
    <div style="display:flex;flex-direction:column;gap:8px">
      <button id="reportWinBtn">Report Win</button>
      <button id="syncBalanceBtn">Refresh Balance</button>
    </div>

    <h4 style="margin-top:12px">Logs</h4>
    <div id="log" class="log"></div>
  </div>
</div>

<div class="row" style="margin-top:12px">
  <div class="card">
    <h3>Telegram WebApp Info</h3>
    <p class="small muted">If opened inside Telegram, the Telegram JS API is available as <code>Telegram.WebApp</code>. We call init on page load and can use it to get user context.</p>
    <pre class="small">// Example: Telegram.WebApp.init();

// const user = Telegram.WebApp.initDataUnsafe.user;</pre> <p class="small">Below are placeholders for backend endpoints — replace <code>/api/...</code> with your deployed server URLs.</p> </div> </div>

  </div><script>
// -----------------------------
// Basic app state
// -----------------------------
const state = {
  balance: 0,
  entryFee: 50,
  inMatch: false,
  dice: null,
  playerTurn: 0, // 0 or 1
  positions: [0,0], // simple linear positions for prototyping
}

const logEl = document.getElementById('log')
function log(msg){
  const p = document.createElement('div'); p.textContent = '['+new Date().toLocaleTimeString()+'] '+msg; logEl.prepend(p)
}

// -----------------------------
// Telegram WebApp init (if present)
// -----------------------------
let tg = null
if(window.Telegram && Telegram.WebApp){
  try{
    Telegram.WebApp.init();
    tg = Telegram.WebApp;
    log('Telegram WebApp detected. initDataUser: '+JSON.stringify(tg.initDataUnsafe?.user || {}))
  }catch(e){console.warn(e)}
} else {
  log('Telegram API not available — running standalone web version')
}

// -----------------------------
// Wallet functions (call your backend)
// -----------------------------
async function fetchBalance(){
  // Placeholder: call backend API
  // const resp = await fetch('/api/get_balance');
  // const data = await resp.json();
  // state.balance = data.balance
  // For prototype, use localStorage
  state.balance = Number(localStorage.getItem('demo_balance') || 200)
  document.getElementById('balance').textContent = state.balance
  log('Balance refreshed: '+state.balance+' coins')
}

async function buyCoins(amount=100){
  // In production: redirect to payment gateway & webhook to credit
  // Prototype: just credit locally
  const curr = Number(localStorage.getItem('demo_balance') || 200)
  localStorage.setItem('demo_balance', curr + amount)
  await fetchBalance()
  log('Bought '+amount+' coins (demo)')
}

async function deductCoins(amount){
  let curr = Number(localStorage.getItem('demo_balance') || 200)
  if(curr < amount) return false
  curr -= amount
  localStorage.setItem('demo_balance', curr)
  await fetchBalance()
  return true
}

async function creditCoins(amount){
  let curr = Number(localStorage.getItem('demo_balance') || 200)
  curr += amount
  localStorage.setItem('demo_balance', curr)
  await fetchBalance()
}

// -----------------------------
// Simple Ludo-like mechanics (prototype)
// -----------------------------
const canvas = document.getElementById('board')
const ctx = canvas.getContext('2d')
const size = canvas.width

function drawBoard(){
  ctx.clearRect(0,0,size,size)
  ctx.fillStyle = '#f8fafc'
  ctx.fillRect(0,0,size,size)
  // draw 2-player linear track with 20 squares
  const n = 20
  const s = size / 10
  ctx.strokeStyle = '#dfe7ff'
  for(let i=0;i<10;i++){
    ctx.strokeRect(i*s,0,s,s)
    ctx.strokeRect(i*s,9*s,s,s)
    ctx.strokeRect(0,i*s,s,s)
    ctx.strokeRect(9*s,i*s,s,s)
  }
  ctx.fillStyle='#fff'
  ctx.font='14px sans-serif'
  ctx.fillText('Player 1 (Blue)',12,24)
  ctx.fillText('Player 2 (Red)',size-130,size-12)

  // draw tokens
  drawToken(state.positions[0], 'blue', 20)
  drawToken(state.positions[1], 'red', size-40)
}

function drawToken(pos, color, baseX){
  const total = 20
  const t = Math.min(total, pos)
  // map position to coordinates around edges (simple mapping)
  let x = 0, y = 0
  if(t <= 9){ x = 10 + t*(size-40)/9; y = 40 }
  else { x = size-40; y = 40 + (t-9)*(size-80)/9 }
  ctx.beginPath(); ctx.fillStyle = color; ctx.arc(x,y,12,0,Math.PI*2); ctx.fill(); ctx.closePath()
}

function rollDice(){
  const d = Math.floor(Math.random()*6)+1
  state.dice = d
  document.getElementById('diceDisplay').textContent = 'Dice: '+d
  log('Dice rolled: '+d)
}

function endTurn(){
  if(state.dice==null){ log('Roll the dice first'); return }
  // move current player's token
  state.positions[state.playerTurn] += state.dice
  log('Player '+(state.playerTurn+1)+' moved '+state.dice+' to '+state.positions[state.playerTurn])
  state.dice = null
  document.getElementById('diceDisplay').textContent = 'Dice: -'
  state.playerTurn = 1 - state.playerTurn
  drawBoard()
}

// -----------------------------
// Match & coin logic
// -----------------------------
async function joinMatch(){
  if(state.inMatch){ log('Already in match'); return }
  const ok = await deductCoins(state.entryFee)
  if(!ok){ log('Not enough coins to join'); alert('Not enough coins — buy more'); return }
  state.inMatch = true
  log('Joined match — entry fee deducted: '+state.entryFee)
  // In real app: tell server to create room / match-making via socket
}

async function leaveMatch(){
  if(!state.inMatch){ log('Not in a match'); return }
  // Refund partial if desired — prototype refunds fully
  await creditCoins(state.entryFee)
  state.inMatch = false
  log('Left match — refunded')
}

async function reportWin(){
  if(!state.inMatch){ log('Not in a match'); return }
  // In production: verify with server. Here we credit demo reward
  const reward = Math.floor(state.entryFee * 1.8) // winner gets 180% of fee (demo)
  await creditCoins(reward)
  state.inMatch = false
  log('Reported win — credited '+reward+' coins (demo)')
  // Ideally: send proof to server: fetch('/api/report_result', {method:'POST', body:...})
}

// -----------------------------
// UI wiring
// -----------------------------
document.getElementById('rollBtn').addEventListener('click', ()=>{ rollDice() })
document.getElementById('endTurnBtn').addEventListener('click', ()=>{ endTurn() })
document.getElementById('buyBtn').addEventListener('click', ()=>{ buyCoins(100) })
document.getElementById('joinBtn').addEventListener('click', ()=>{ joinMatch() })
document.getElementById('leaveBtn').addEventListener('click', ()=>{ leaveMatch() })
document.getElementById('reportWinBtn').addEventListener('click', ()=>{ reportWin() })
document.getElementById('syncBalanceBtn').addEventListener('click', ()=>{ fetchBalance() })

// initial draw & fetch
fetchBalance(); drawBoard();

</script><!--
====================
Server stub (Node.js + Express + Socket.IO)
Copy this block into server.js and run `node server.js` after installing dependencies.
This is a minimal starting point. You must add authentication, ledger, persistent DB, and webhook handling for payments.

// server.js (example)
const express = require('express');
const http = require('http');
const { Server } = require('socket.io');
const app = express();
const server = http.createServer(app);
const io = new Server(server, { cors: { origin: '*' } });
app.use(express.json());

// In-memory demo ledger (replace with DB)
const users = {}; // {telegramId: {balance: 100}}

app.get('/api/get_balance', (req,res)=>{
  // TODO: authenticate user
  const t = req.query.t || 'demo';
  res.json({balance: users[t]?.balance || 200});
});

app.post('/api/buy_coins', (req,res)=>{
  // Payment gateway will call webhook in real app
  const {user, amount} = req.body;
  users[user] = users[user] || {balance:200};
  users[user].balance += amount;
  res.json({ok:true, balance:users[user].balance});
});

app.post('/api/report_result', (req,res)=>{
  const {user, amount} = req.body;
  users[user] = users[user] || {balance:200};
  users[user].balance += amount;
  res.json({ok:true});
});

io.on('connection', (socket)=>{
  console.log('socket connected', socket.id);
  socket.on('join', (data)=>{ console.log('join', data)});
});

server.listen(3000, ()=>console.log('Server running on :3000'))

====================
Important notes:
- Replace demo localStorage wallet with server ledger + DB.
- For Telegram integration: use Telegram bot to send WebApp button with url to this page.
- For payments: integrate bKash/Nagad with server route /api/payment_webhook to credit ledger upon success.
- Move all game-critical logic (dice RNG for tournament/outcome, move validation, winner calc) to server to avoid cheating.
--></body>
</html>
